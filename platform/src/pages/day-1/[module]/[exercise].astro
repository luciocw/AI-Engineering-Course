---
import LessonLayout from '@/layouts/lesson-layout.astro';
import ExercisePlayground from '@/components/react/ExercisePlayground';
import ExerciseSidebar from '@/components/react/ExerciseSidebar';
import { getAllExercisePaths, getAdjacentExercises, canRunInBrowser } from '@/lib/course/exercises';
import { url } from '@/lib/url';
import { getCollection, render } from 'astro:content';

export function getStaticPaths() {
  return getAllExercisePaths();
}

const { exercise, module: mod, day } = Astro.props;
const { prev, next } = getAdjacentExercises(mod.slug, exercise.slug);

// Load lesson content from MDX collection
const allLessons = await getCollection('lessons');
const lesson = allLessons.find(
  (l) => l.data.module === mod.slug && l.id.includes(exercise.slug)
);
let LessonContent: any = null;
if (lesson) {
  const rendered = await render(lesson);
  LessonContent = rendered.Content;
}

// Load all exercise and solution files at build time
const exerciseFiles = import.meta.glob(
  '/../day-1/**/exercises/*.ts',
  { query: '?raw', import: 'default', eager: true }
) as Record<string, string>;

const solutionFiles = import.meta.glob(
  '/../day-1/**/solutions/*.ts',
  { query: '?raw', import: 'default', eager: true }
) as Record<string, string>;

// Find the matching files for this exercise
function findFile(files: Record<string, string>, moduleSlug: string, exerciseSlug: string): string {
  for (const [path, content] of Object.entries(files)) {
    if (path.includes(moduleSlug) && path.includes(exerciseSlug)) {
      return content;
    }
  }
  return `// File not found: ${moduleSlug}/${exerciseSlug}`;
}

const exerciseCode = findFile(exerciseFiles, mod.slug, exercise.slug);
const solutionCode = findFile(solutionFiles, mod.slug, exercise.slug);

// Prepare sidebar data
const sidebarExercises = mod.exercises.map((ex: typeof exercise) => ({
  slug: ex.slug,
  title: ex.title,
  difficulty: ex.difficulty,
}));
---

<LessonLayout
  title={`${exercise.title} â€” ${mod.title} â€” Build.AI`}
  description={exercise.description}
  breadcrumbs={[
    { label: 'Home', href: url('/') },
    { label: 'Day 1', href: url('/day-1') },
    { label: mod.title, href: url(`/day-1/${mod.slug}`) },
    { label: exercise.title },
  ]}
>
  <Fragment slot="sidebar">
    <ExerciseSidebar
      client:load
      exercises={sidebarExercises}
      currentSlug={exercise.slug}
      moduleSlug={mod.slug}
      moduleTitle={mod.title}
      basePath={import.meta.env.BASE_URL.replace(/\/$/, '')}
    />
  </Fragment>

  {LessonContent && (
    <details class="group rounded-xl border border-[var(--color-border)] bg-[var(--color-surface)] mb-6" open>
      <summary class="cursor-pointer px-5 py-3 text-sm font-semibold text-[var(--color-text)] flex items-center justify-between">
        <span>ðŸ“– Lesson</span>
        <svg class="w-4 h-4 text-[var(--color-text-muted)] group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </summary>
      <div class="px-5 pb-5 prose prose-invert prose-sm max-w-none border-t border-[var(--color-border)] pt-4">
        <LessonContent />
      </div>
    </details>
  )}

  <ExercisePlayground
    client:load
    exerciseCode={exerciseCode}
    solutionCode={solutionCode}
    exerciseSlug={exercise.slug}
    moduleSlug={mod.slug}
    title={exercise.title}
    description={exercise.description}
    difficulty={exercise.difficulty}
    estimatedMinutes={exercise.estimatedMinutes}
    canRunInBrowser={canRunInBrowser(mod.slug)}
    prevExercise={prev}
    nextExercise={next}
  />
</LessonLayout>
